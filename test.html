<!DOCTYPE html>
<html>
	<head>
		<title>Artic Regions</title>

		<script src="js/jquery.js"></script>
		<script src="js/d3.js"></script>

		<!-- <link href='../libs/css/crimson_text_font.css' rel='stylesheet' type='text/css'> -->
            <!-- <link rel="stylesheet" href="../libs/css/template.css"> -->

		<style type="text/css">
			.head-sections {
				display: inline-block;
				width: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden;
				position: relative;
			}

			h1 {
				color: white;
				text-align: center;
				top: 50%;
				position: relative;
				font-size: 50pt;
				z-index: 1;
			}

			h2 {
				color: white;
				text-align: center;
				top: 50%;
				position: relative;
				z-index: 1;
			}

			p {
				color: black;
			}
			.full-image {
				position: absolute;
				z-index: 0;
				width: 100%;
			}
			.map-image {
				width: 100%;
			}

			body, html {
				margin:0;
				padding:0;
			}
			#body-section {
				position: absolute;
				display: block;
				width: 100%;
			}

			#map {
				margin:0;
				padding: 0;
			}

			#sidenotes_wrapper {
				/*font-size: small;*/
				/*position: fixed;*/
				visibility: visible;
				width:375px;
				height:100%;
				left:0;
				/*position:absolute;*/
				padding-left: 10px;
				padding-right:15px;

			}

			#sidebar_inner {
				position: fixed;
				top: 0;
				left: 0;
				width: 375px;
				overflow-y:hidden;

				/*overflow-x:hidden;*/
				/*height: 100%;*/
			}

			#essay_wrapper {
				overflow:auto;
				position:absolute;
			}

			@media screen and (max-width: 1000px) {
				#essay_wrapper {
					width:100%;
					right:0;
				}
				#sidenotes_wrapper, #side_image {
					visibility: hidden;
				}
			}

			p {
				line-height: 2;
				padding-left: 20px;
			}

			#side_image {
				width:375px;
				/*height: 100%;*/
				/*max-width: 100%;*/
				max-height: 100%;
			}

		</style>

	</head>
	<body>
<!-- 		<header>
			Some text.
		</header> -->
		<div class="head-sections" id="head-section">
			<img id="head-image" class="full-image" src="images/home_image.jpg"/>
			<h1>Arctic Regions</h1>
			<h2>By: George Philip LeBourdais</h2>
		</div>
		<div id="map">
			
			<img class="map-image" src="images/map_image.png" />
			
		</div>

		<div id="body-section">
			<div id="essay_wrapper">

				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin non convallis tortor. Praesent mattis quam arcu, id venenatis orci finibus in. Aenean justo nibh, dignissim quis ultrices vitae, pulvinar at lorem. Morbi et felis sed justo eleifend dapibus a nec purus. Sed gravida turpis lacinia, blandit dolor ut, vestibulum quam. Integer sit amet quam ut metus finibus aliquam sed eu eros. Suspendisse sagittis felis ac lacus lobortis feugiat.</p>

				<p>Mauris sollicitudin nibh ac libero fringilla lacinia. Suspendisse maximus, dui et semper varius, ipsum libero finibus nunc, vitae laoreet sem nibh vel purus. Vivamus rutrum massa ac ligula sagittis cursus. Proin laoreet ullamcorper ante, ut mollis dolor iaculis ut. Etiam nec sapien a sapien viverra volutpat. Donec sodales sem ac dolor dictum, ut sollicitudin lorem ultricies. Maecenas ac leo mollis orci imperdiet aliquam ac ac dolor. Vestibulum in sodales nisi. Integer pretium laoreet purus, sed facilisis ipsum pharetra sit amet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. In condimentum tincidunt orci, quis eleifend diam. Nullam lectus dolor, pretium eget maximus eget, semper at odio. Suspendisse potenti. Vestibulum auctor blandit lacus, nec condimentum ligula varius sed.</p>

				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin non convallis tortor. Praesent mattis quam arcu, id venenatis orci finibus in. Aenean justo nibh, dignissim quis ultrices vitae, pulvinar at lorem. Morbi et felis sed justo eleifend dapibus a nec purus. Sed gravida turpis lacinia, blandit dolor ut, vestibulum quam. Integer sit amet quam ut metus finibus aliquam sed eu eros. Suspendisse sagittis felis ac lacus lobortis feugiat.</p>

				<p>Mauris sollicitudin nibh ac libero fringilla lacinia. Suspendisse maximus, dui et semper varius, ipsum libero finibus nunc, vitae laoreet sem nibh vel purus. Vivamus rutrum massa ac ligula sagittis cursus. Proin laoreet ullamcorper ante, ut mollis dolor iaculis ut. Etiam nec sapien a sapien viverra volutpat. Donec sodales sem ac dolor dictum, ut sollicitudin lorem ultricies. Maecenas ac leo mollis orci imperdiet aliquam ac ac dolor. Vestibulum in sodales nisi. Integer pretium laoreet purus, sed facilisis ipsum pharetra sit amet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. In condimentum tincidunt orci, quis eleifend diam. Nullam lectus dolor, pretium eget maximus eget, semper at odio. Suspendisse potenti. Vestibulum auctor blandit lacus, nec condimentum ligula varius sed.</p>
				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin non convallis tortor. Praesent mattis quam arcu, id venenatis orci finibus in. Aenean justo nibh, dignissim quis ultrices vitae, pulvinar at lorem. Morbi et felis sed justo eleifend dapibus a nec purus. Sed gravida turpis lacinia, blandit dolor ut, vestibulum quam. Integer sit amet quam ut metus finibus aliquam sed eu eros. Suspendisse sagittis felis ac lacus lobortis feugiat.</p>

				<p>Mauris sollicitudin nibh ac libero fringilla lacinia. Suspendisse maximus, dui et semper varius, ipsum libero finibus nunc, vitae laoreet sem nibh vel purus. Vivamus rutrum massa ac ligula sagittis cursus. Proin laoreet ullamcorper ante, ut mollis dolor iaculis ut. Etiam nec sapien a sapien viverra volutpat. Donec sodales sem ac dolor dictum, ut sollicitudin lorem ultricies. Maecenas ac leo mollis orci imperdiet aliquam ac ac dolor. Vestibulum in sodales nisi. Integer pretium laoreet purus, sed facilisis ipsum pharetra sit amet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. In condimentum tincidunt orci, quis eleifend diam. Nullam lectus dolor, pretium eget maximus eget, semper at odio. Suspendisse potenti. Vestibulum auctor blandit lacus, nec condimentum ligula varius sed.</p>
				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin non convallis tortor. Praesent mattis quam arcu, id venenatis orci finibus in. Aenean justo nibh, dignissim quis ultrices vitae, pulvinar at lorem. Morbi et felis sed justo eleifend dapibus a nec purus. Sed gravida turpis lacinia, blandit dolor ut, vestibulum quam. Integer sit amet quam ut metus finibus aliquam sed eu eros. Suspendisse sagittis felis ac lacus lobortis feugiat.</p>

				<p>Mauris sollicitudin nibh ac libero fringilla lacinia. Suspendisse maximus, dui et semper varius, ipsum libero finibus nunc, vitae laoreet sem nibh vel purus. Vivamus rutrum massa ac ligula sagittis cursus. Proin laoreet ullamcorper ante, ut mollis dolor iaculis ut. Etiam nec sapien a sapien viverra volutpat. Donec sodales sem ac dolor dictum, ut sollicitudin lorem ultricies. Maecenas ac leo mollis orci imperdiet aliquam ac ac dolor. Vestibulum in sodales nisi. Integer pretium laoreet purus, sed facilisis ipsum pharetra sit amet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. In condimentum tincidunt orci, quis eleifend diam. Nullam lectus dolor, pretium eget maximus eget, semper at odio. Suspendisse potenti. Vestibulum auctor blandit lacus, nec condimentum ligula varius sed.</p>
				<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin non convallis tortor. Praesent mattis quam arcu, id venenatis orci finibus in. Aenean justo nibh, dignissim quis ultrices vitae, pulvinar at lorem. Morbi et felis sed justo eleifend dapibus a nec purus. Sed gravida turpis lacinia, blandit dolor ut, vestibulum quam. Integer sit amet quam ut metus finibus aliquam sed eu eros. Suspendisse sagittis felis ac lacus lobortis feugiat.</p>

				<p>Mauris sollicitudin nibh ac libero fringilla lacinia. Suspendisse maximus, dui et semper varius, ipsum libero finibus nunc, vitae laoreet sem nibh vel purus. Vivamus rutrum massa ac ligula sagittis cursus. Proin laoreet ullamcorper ante, ut mollis dolor iaculis ut. Etiam nec sapien a sapien viverra volutpat. Donec sodales sem ac dolor dictum, ut sollicitudin lorem ultricies. Maecenas ac leo mollis orci imperdiet aliquam ac ac dolor. Vestibulum in sodales nisi. Integer pretium laoreet purus, sed facilisis ipsum pharetra sit amet. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. In condimentum tincidunt orci, quis eleifend diam. Nullam lectus dolor, pretium eget maximus eget, semper at odio. Suspendisse potenti. Vestibulum auctor blandit lacus, nec condimentum ligula varius sed.</p>

				<p>Aliquam posuere massa at nunc tempor, vitae mollis risus tincidunt. Ut convallis orci nec aliquet facilisis. Pellentesque finibus bibendum ante, sed convallis tortor molestie quis. Morbi sagittis tincidunt risus, sit amet mattis mi ullamcorper sed. Nulla ac mattis quam, in suscipit nisl. Curabitur lectus dui, hendrerit in vulputate non, tempor ac augue. Integer et mollis ex, quis vulputate sem. Ut aliquet lacinia erat, a feugiat nibh congue eget. Proin quis gravida neque. Aenean quis dolor eget odio condimentum pulvinar non vel dolor. Quisque at mattis dolor, non ullamcorper massa. Nullam in urna nec eros rutrum elementum. Vivamus quis rutrum magna, vel vestibulum est.</p>

				<p>Duis a nibh sapien. Pellentesque mauris purus, auctor sed libero vel, efficitur tempor enim. Duis tristique posuere sem, eu vehicula neque. Maecenas lobortis tellus ut tellus volutpat vulputate vel ac neque. Donec sed turpis sit amet tellus facilisis placerat quis at mauris. Duis nec ex justo. Etiam mollis scelerisque erat. Integer vel molestie magna, non semper lectus. Mauris dapibus justo magna, efficitur vestibulum neque imperdiet sit amet.</p>
			</div>
			<div id="sidenotes_wrapper">
				<!-- <div id="sidebar_inner"> -->
				<!-- <img id="side_image" src="images/side_map.jpg"/> -->
					<!-- <p>Sidebar Sidebar Sidebar Sidebar  Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar  Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar  Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar  Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar </p>

					<p>Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar </p>

					<p>Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar Sidebar </p>
			</div> -->

			<div class="section map-section map-left"></div>
			<script>
  
  if (!/iPad|iPod|iPhone/.test(navigator.userAgent)) defer(function() {
  
  var width,
      height,
      nativeHeight = 1000,
      scale,
      y0,
      y1;
  
  var y = d3.scale.linear()
      .range([0, .125, .171, .267, .455, .613, .680, .955, 1]);
  
  var resizeTimeout,
      render = function() {};
  
  var path = d3.geo.path()
      .projection(d3.geo.transform({point: function(x, y) { this.stream.point(x * scale, y * scale); }}));
  
  var section = d3.select(".map-left");
  
  var svg = section.append("svg");
  
  var g = svg.append("g");
  
  var marker = d3.selectAll([]);
  
  var article = d3.select(".article");
  
  d3.select(window)
      .on("resize.map-left", resized)
      .on("load.map-left", resized)
      .call(resized);
  
  function resized() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(afterresized, 10);
  }
  
  function afterresized() {
    width = document.body.clientWidth / 4;
    height = innerHeight;
    scale = (height - 200) / nativeHeight;
    y0 = article.node().offsetTop;
    y1 = y0 + article.node().offsetHeight - innerHeight;
  
    svg
        .attr("width", width)
        .attr("height", height);
  
    g
        .attr("transform", "translate(" + (width / 2 + 48) + "," + height / 2 + ")");
  
    y
        .domain(marker
          .each(function(d) { d.properties.position = this.offsetTop; })
          .data().map(function(d) { return d.properties.position; }));
  
    render();
  }
  
  d3.json("http://graphics8.nytimes.com/newsgraphics/2013/10/13/russia/207ffeebeb08f93156b7a4be9b0c17863de3143a/map-left.json", function(error, topo) {
    var road = topojson.feature(topo, topo.objects.road),
        roadLength = length(road.geometry.coordinates),
        cities = topojson.feature(topo, topo.objects.cities).features;
  
    marker = d3.selectAll(".map-marker")
        .data(cities, function(d) { return d ? d.properties.name : this.getAttribute("data-key"); })
        .each(function(d, i) { d.properties.position = this.offsetTop; d.properties.top = y.range()[i]; });
  
    y.domain(cities.map(function(d) { return d.properties.position; }));
  
    g.append("path")
        .datum(road)
        .attr("class", "map-road");
  
    var feature = g.append("path")
        .datum(road)
        .attr("class", "map-road map-road--story");
  
    var label = g.append("g")
        .attr("class", "map-label map-label--road")
      .selectAll("g")
        .data(cities)
      .enter().append("g")
        .on("click", clicked);
  
    label.append("circle")
        .attr("r", 2.5);
  
    label.append("text")
        .attr("dy", ".35em")
        .attr("x", -10)
        .text(function(d) { return d.properties.name; });
  
    render = function() {
      g.selectAll("path").attr("d", path);
      label.attr("transform", function(d) { d = d.geometry.coordinates; return "translate(" + d[0] * scale + "," + d[1] * scale + ")"; });
      scrolled();
    };
  
    d3.select(window)
        .on("scroll.map-left", scrolled)
        .call(render);
  
    function scrolled() {
      var top = y(pageYOffset), maxTop = 0;
  
      section
          .style("top", pageYOffset > y1 ? y1 - pageYOffset + "px" : pageYOffset < y0 ? y0 - pageYOffset + "px" : null);
  
      feature
          .style("stroke-dasharray", top * roadLength * scale + "," + roadLength * scale);
  
      label
          .classed("map-label--visited", function(d) { var t = d.properties.top; if (t < top) { if (t > maxTop) maxTop = t; return true; }})
          .classed("map-label--visiting", function(d) { return d.properties.top === maxTop; });
    }
  
    function clicked(d, i) {
      d3.transition()
          .duration(750)
          .tween("scroll", function() {
            var offset = d3.interpolateNumber(pageYOffset, d.properties.position + (i ? 40 : 0));
            return function(t) { scrollTo(0, offset(t)); };
          });
    }
  });
  
  function length(line) {
    var i = 0,
        n = line.length,
        p0,
        p1 = line[0],
        length = 0,
        dx,
        dy;
  
    while (++i < n) {
      p0 = p1;
      p1 = line[i];
      dx = p1[0] - p0[0];
      dy = p1[1] - p0[1];
      length += Math.sqrt(dx * dx + dy * dy);
    }
  
    return length;
  }
  
  });
  
  </script>
			</div>
		</div>

		<script>

			if ($(window).height() < 1600) {
				$('#head-section').css({'height': $(window).height() - 20 + 'px'});
			} else {
				$('#head-section').css({'height': 1580 + 'px'});
			}
			
			if ($(window).width() < $(window).height()) {
				$('#head-section').css({'height': $(window).width() + 'px'});
			}

			if ($(window).width() > 1000) {
				$('#essay_wrapper').css({'width':$(window).width() - 360});
				$('#essay_wrapper').css({'right': 0});
			} else {
				$('#essay_wrapper').css({'width': 100 + '%'});
			}

			var scrollTop = $(this).scrollTop();

			var topDistance = $('#essay_wrapper').offset().top;

			if(topDistance < scrollTop) {
				$('#sidebar_inner').css({'position':'fixed'});
				$('#sidebar_inner').css({'height': 100 + '%'});
				if ($(window).height() < 900) {
					$('#sidebar_inner').css({'overflow-y': 'scroll'});
				} else {
					$('#sidebar_inner').css({'overflow-y': 'hidden'});
				}
			} else {
				$('#sidebar_inner').css({'position':'absolute'});
				$('#sidebar_inner').css({'height': 'initial'});
			}

			$(window).on('scroll', function() {
				var scrollTop = $(this).scrollTop();

				var topDistance = $('#essay_wrapper').offset().top;

				if(topDistance < scrollTop) {
					$('#sidebar_inner').css({'position':'fixed'});
					$('#sidebar_inner').css({'height': 100 + '%'});
					if ($(window).height() < 900) {
						$('#sidebar_inner').css({'overflow-y': 'scroll'});
					} else {
						$('#sidebar_inner').css({'overflow-y': 'hidden'});
					}
				} else {
					$('#sidebar_inner').css({'position':'absolute'});
					$('#sidebar_inner').css({'height': 'initial'});
				}
			});

			$(window).resize( function () {
				if ($(window).height() < 1600) {
					$('#head-section').css({'height': $(window).height() - 20 + 'px'});

				} else {
					$('#head-section').css({'height': 1580 + 'px'});
				}
				if ($(window).width() < $(window).height()) {
					$('#head-section').css({'height': $(window).width() + 'px'});
				}

				if ($(window).width() > 1000) {
					$('#essay_wrapper').css({'width':$(window).width() - 360});
					$('#essay_wrapper').css({'right': 0});
				} else {
					$('#essay_wrapper').css({'width': 100 + '%'});
				}

				var scrollTop = $(this).scrollTop();

				var topDistance = $('#essay_wrapper').offset().top;

				if(topDistance < scrollTop) {
					$('#sidebar_inner').css({'position':'fixed'});
					$('#sidebar_inner').css({'height': 100 + '%'});
					if ($(window).height() < 900) {
						$('#sidebar_inner').css({'overflow-y': 'scroll'});
					} else {
						$('#sidebar_inner').css({'overflow-y': 'hidden'});
					}
				} else {
					$('#sidebar_inner').css({'position':'absolute'});
					$('#sidebar_inner').css({'height': 'initial'});
				}

			});

		</script>

		<script>


			document.querySelector(".map-section.map-overview").style.height = pageHeight() + "px";

			defer(function() {

			var top = 0,
			    nativeSize = 2000,
			    miles = 200,
			    width,
			    π = Math.PI,
			    τ = 2 * π;

			var watch = d3.behavior.watch()
			    .on("statechange", statechanged)
			    .on("scroll", scrolled);

			var section = d3.selectAll(".map-section.map-overview")
			    .datum(function() {
			      return {
			        zoom: d3.interpolateNumber(+this.getAttribute("data-zoom-start"), +this.getAttribute("data-zoom-end")),
			        path: d3.geo.path().projection(null)
			      };
			    })
			    .call(watch);

			var svg = section.append("svg");

			var gTranslate = svg.append("g")
			    .attr("class", "map-translate");

			var gKey = svg.append("g")
			    .attr("class", "map-key");

			var projection = d3.geo.azimuthalEquidistant()
			    .translate([0, 0]);

			var render = function() {};

			d3.select(window)
			    .on("resize.map-overview", resized)
			    .call(resized);

			function resized() {
			  svg
			      .attr("width", width = document.body.clientWidth)
			      .attr("height", function(d) { return d.height = pageHeight(); });

			  section
			      .style("height", function(d) { return d.height + "px"; })
			      .each(render);
			}

			d3.json("http://graphics8.nytimes.com/newsgraphics/2013/10/13/russia/207ffeebeb08f93156b7a4be9b0c17863de3143a/map-overview.json", function(error, topo) {
			  var labels = topojson.feature(topo, topo.objects.labels),
			      roadCities = topojson.feature(topo, topo.objects.road_cities),
			      russianCities = topojson.feature(topo, topo.objects.russian_cities),
			      europeanCities = topojson.feature(topo, topo.objects.european_cities);

			  europeanCities.features.forEach(function(f) {
			    if (f.properties.name === "København") f.properties.name = "Copenhagen";
			  });

			  section.each(function(d) {
			    var section = d3.select(this),
			        gTranslate = section.select(".map-translate"),
			        gKey = section.select(".map-key"),
			        path = d.path;

			    // gTranslate.append("image")
			    //     .attr("xlink:href", "http://graphics8.nytimes.com/newsgraphics/2013/10/13/russia/207ffeebeb08f93156b7a4be9b0c17863de3143a/map-overview.jpg")
			    //     .attr("x", -nativeSize / 2)
			    //     .attr("y", -nativeSize / 2)
			    //     .attr("width", nativeSize)
			    //     .attr("height", nativeSize);

			    gTranslate.append("g")
			        .attr("class", "map-chatter")
			        .attr("transform", "translate(0,-160)")
			      .selectAll("text")
			        .data([
			          "On the jarring, 12-hour drive from ",
			          "St. Petersburg to Moscow, another ",
			          "Russia comes into view, one where ",
			          "people struggle with problems that ",
			          "belong to past centuries."
			        ])
			      .enter().append("text")
			        .attr("dy", function(d, i) { return i * 1.4 + "em"; })
			        .text(function(d) { return d; });

			    gTranslate.append("g")
			        .attr("class", "map-label map-label--country")
			      .selectAll("text")
			        .data(labels.features)
			      .enter().append("text")
			        .attr("dy", ".35em")
			        .text(function(d) { return d.properties.name.toUpperCase(); });

			    gTranslate.append("g")
			        .attr("class", "map-label map-label--city map-label--road")
			      .selectAll("text")
			        .data(roadCities.features)
			      .enter().append("text")
			        .attr("dy", ".35em")
			        .attr("x", function(d) { return d.properties.name === "Moscow" ? 10 : -10; })
			        .style("text-anchor", function(d) { return d.properties.name === "Moscow" ? "start" : "end"; })
			        .text(function(d) { return d.properties.name; });

			    gTranslate.append("g")
			        .attr("class", "map-label map-label--city map-label--russia")
			        .attr("transform", "translate(0,-7)")
			      .selectAll("text")
			        .data(russianCities.features.filter(function(d) { return d.properties.name !== "St. Petersburg" && d.properties.name !== "Moscow"; }))
			      .enter().append("text")
			        .text(function(d) { return d.properties.name; });

			    gTranslate.append("g")
			        .attr("class", "map-label map-label--city")
			        .attr("transform", "translate(0,-7)")
			      .selectAll("text")
			        .data(europeanCities.features)
			      .enter().append("text")
			        .text(function(d) { return d.properties.name; });

			    gKey.append("path");

			    gKey.append("text")
			        .attr("y", -4)
			        .text("Miles");

			    gKey.append("text")
			        .attr("y", 8)
			        .attr("dy", ".71em")
			        .text(0);

			    gKey.append("text")
			        .attr("y", 8)
			        .attr("dy", ".71em")
			        .text(miles);
			  });

			  render = function(d) {
			    var section = d3.select(this),
			        svg = section.select("svg"),
			        gTranslate = section.select(".map-translate"),
			        gKey = section.select(".map-key");

			    var height = d.height,
			        availHeight = innerHeight - 40,
			        t = (availHeight - top) / (availHeight + height),
			        scale = Math.max(height, width) / nativeSize * Math.pow(2, d.zoom(t)),
			        visibleHeight = top < 0 ? height + top : Math.min(height, availHeight - top) + 40;

			    // Compute geographic distance along 10% width segment, and round to a nice number.
			    // Then convert distance back to angular measure in degrees and project.
			    var pixels = Math.round(projection.scale(3500 * scale)([miles / 3963.1676 * 180 / π, 0])[0]);

			    svg.select("image")
			        .attr("transform", "scale(" + scale + ")");

			    gTranslate
			        .attr("transform", "translate(" + width / 2 + "," + (t * height + 20) + ")");

			    gTranslate.selectAll(".map-label > text")
			        .attr("transform", function(d) { return "translate(" + d.geometry.coordinates[0] * scale + "," + d.geometry.coordinates[1] * scale + ")"; });

			    gTranslate.select(".map-chatter")
			        .style("fill-opacity", Math.min(1, (t - .28) * 4));

			    gKey
			        .attr("transform", "translate(" + (width - pixels - 80.5) + "," + ((top > 0 ? visibleHeight : height) - 80.5) + ")");

			    gKey.select("path")
			        .attr("d", "M0,5V0H" + pixels + "V5");

			    gKey.select("text:first-of-type")
			        .attr("x", pixels / 2);

			    gKey.select("text:last-of-type")
			        .attr("x", pixels);
			  };

			  section.each(render);
			});

			function statechanged() {
			  d3.select(this).select("svg").style("display", d3.event.state ? null : "none");
			}

			function scrolled() {
			  top = d3.event.rect.top;
			  d3.select(this).each(render);
			}

			});

			</script>


			<script>
			(function() {

			var watched = [];

			d3.behavior.watch = function() {
			  var event = d3.dispatch("statechange", "scroll");

			  function watch(selection) {
			    selection.each(function(i) {
			      watched.push({
			        element: this,
			        state: 0,
			        index: i,
			        event: event
			      });
			    });
			  }

			  return d3.rebind(watch, event, "on");
			};

			if (/iPhone|iPad|iPad/.test(navigator.userAgent)) {
			  d3.select("body")
			      .classed("ios", "true");

			  d3.select(window)
			      .on("resize.watch", watch_scrolledStatic)
			      .on("DOMContentLoaded.watch", watch_scrolledStatic);
			} else {
			  d3.select(window)
			      .on("resize.watch", watch_scrolled)
			      .on("scroll.watch", watch_scrolled)
			      .on("DOMContentLoaded.watch", watch_scrolled);
			}

			function watch_scrolled() {
			  watched.forEach(function(watch) {
			    var rect = watch.element.getBoundingClientRect();
			    if (rect.top + rect.height < 0 || rect.bottom - rect.height - innerHeight > 0) {
			      watch_state(watch, 0);
			    } else {
			      var t = rect.top / (innerHeight - rect.height);
			      watch_state(watch, t < 0 || t > 1 ? 1 : 2);
			      watch_dispatch(watch, {type: "scroll", offset: t, rect: rect});
			    }
			  });
			}

			function watch_scrolledStatic() {
			  watched.forEach(function(watch) {
			    watch_state(watch, 1);
			    watch_dispatch(watch, {type: "scroll", offset: .5, rect: {top: 0}}); // XXX rect
			  });
			}

			function watch_state(watch, state1) {
			  var state0 = watch.state;
			  if (state0 !== state1) watch_dispatch(watch, {
			    type: "statechange",
			    state: watch.state = state1,
			    previousState: state0
			  });
			}

			function watch_dispatch(watch, event) {
			  var element = watch.element,
			      sourceEvent = event.sourceEvent = d3.event;
			  try {
			    d3.event = event;
			    watch.event[event.type].call(element, element.__data__, watch.index);
			  } finally {
			    d3.event = sourceEvent;
			  }
			}

			await();

			})();
			</script>
	</body>
</html>